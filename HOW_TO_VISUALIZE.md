# How to Visualize Transformer Predictions

This guide walks you through the complete process of visualizing your EEG source localization predictions on a 3D brain surface.

## Overview

You have:
1. ✅ Trained a transformer model that predicts brain activity in 994 regions
2. ✅ Run `eval_real.py` to generate predictions saved in `.mat` files
3. ⏳ Want to visualize these predictions on a 3D cortex surface

## Prerequisites

- MATLAB installed (R2020a or later recommended)
- Prediction file generated by `eval_real.py` (e.g., `source/VEP/transformer_predictions_best_model.mat`)
- Anatomy files in the `anatomy/` folder

## Step-by-Step Guide

### Step 1: Verify Your Setup

Open MATLAB and navigate to your project:

```matlab
cd D:\fyp\EEG_Inverse_Problem_with_Transformer_Model\misc_scripts
```

Run the test script to verify everything is ready:

```matlab
test_visualization
```

This will check:
- ✓ Anatomy files exist
- ✓ Prediction files exist
- ✓ Data can be loaded correctly
- ✓ Visualization function works

If all tests pass, you're ready to proceed!

### Step 2: Inspect Your Data (Optional but Recommended)

To understand what data you have:

```matlab
inspect_anatomy_data
```

This will show:
- Cortex geometry (20,484 vertices forming the brain surface)
- Region mapping (how vertices map to 994 regions)
- Multiple views of the cortex
- Statistics about your data

### Step 3: Visualize Your Predictions

#### Option A: Visualize Multiple Samples (Recommended)

```matlab
visualize_transformer_predictions
```

This will:
1. Load your predictions from `source/VEP/transformer_predictions_best_model.mat`
2. Convert region-level predictions (994) to vertex-level (20,484)
3. Display the first 5 samples in a subplot
4. Print statistics

#### Option B: Visualize a Single Sample

For interactive exploration:

```matlab
visualize_single_prediction(1)  % Sample 1
visualize_single_prediction(3)  % Sample 3
```

### Step 4: Customize (Optional)

To adjust visualization parameters, edit `visualize_transformer_predictions.m`:

```matlab
% Open the file
edit visualize_transformer_predictions.m

% Key parameters to adjust:
num_samples_to_show = 10;   % Show more samples
subplot_rows = 2;           % 2 rows
subplot_cols = 5;           % 5 columns
face_alpha = 0.9;           % Less transparent (0-1)
threshold = 0.2;            % Only show strong activations (0-1)
view_angle = [90, 0];       % Different camera angle
```

### Step 5: Save Your Figures

After visualization, save the figure:

```matlab
saveas(gcf, 'my_predictions.png')
saveas(gcf, 'my_predictions.fig')  % MATLAB format for later editing
```

Or uncomment the save section in `visualize_transformer_predictions.m` for automatic saving.

## Understanding the Visualization

### What You're Seeing

- **Brain Surface**: The cortex with 20,484 vertices
- **Colors**: Represent predicted brain activity
  - Gray: No/low activity
  - Yellow/Red: High activity
- **Colormap**: Normalized to [0, 1] by default

### Data Transformation

Your transformer outputs 994 region values. The visualization converts these to 20,484 vertex values using the region mapping:

```
Transformer Output: (num_samples, 994 regions)
         ↓
Region Mapping: Each vertex belongs to one region
         ↓
Vertex Values: (num_samples, 20,484 vertices)
         ↓
3D Visualization on cortex surface
```

### View Angles

Common viewing angles:

| Angle | View | Description |
|-------|------|-------------|
| `[-86, 17]` | Left lateral | Default, shows left side |
| `[86, 17]` | Right lateral | Shows right side |
| `[0, 90]` | Top | Bird's eye view |
| `[0, 0]` | Front | Face view |
| `[180, 0]` | Back | Back of head |

You can rotate the figure interactively using MATLAB's rotation tool.

## Advanced Usage

### Compare Multiple Models

To compare predictions from different checkpoints:

```matlab
% Edit compare_predictions.m
prediction_files = {
    '../source/VEP/transformer_predictions_best_model.mat';
    '../source/VEP/transformer_predictions_epoch50.mat';
};

% Run comparison
compare_predictions
```

### Multiple Views of Same Sample

```matlab
% Load data once
cd misc_scripts
cortex_data = load('../anatomy/fs_cortex_20k.mat');
rm_data = load('../anatomy/fs_cortex_20k_region_mapping.mat');
pred_data = load('../source/VEP/transformer_predictions_best_model.mat');

% Convert to vertex level (sample 1)
vertex_values = zeros(size(cortex_data.pos, 1), 1);
for i = 1:length(rm_data.region_mapping)
    region_id = rm_data.region_mapping(i);
    if region_id > 0
        vertex_values(i) = pred_data.all_out(1, region_id);
    end
end

% Show 4 views
figure('Position', [100, 100, 1600, 800]);

subplot(2,2,1);
visualize_result(cortex_data.pos, cortex_data.tri, vertex_values', ...
    'view', [-86, 17], 'new_fig', 0, 'FaceAlpha', 0.8);
title('Left View');

subplot(2,2,2);
visualize_result(cortex_data.pos, cortex_data.tri, vertex_values', ...
    'view', [86, 17], 'new_fig', 0, 'FaceAlpha', 0.8);
title('Right View');

subplot(2,2,3);
visualize_result(cortex_data.pos, cortex_data.tri, vertex_values', ...
    'view', [0, 90], 'new_fig', 0, 'FaceAlpha', 0.8);
title('Top View');

subplot(2,2,4);
visualize_result(cortex_data.pos, cortex_data.tri, vertex_values', ...
    'view', [0, 0], 'new_fig', 0, 'FaceAlpha', 0.8);
title('Front View');
```

### Batch Export All Samples

```matlab
% Load data
cortex_data = load('../anatomy/fs_cortex_20k.mat');
rm_data = load('../anatomy/fs_cortex_20k_region_mapping.mat');
pred_data = load('../source/VEP/transformer_predictions_best_model.mat');

% Create output directory
output_dir = '../results/visualizations/';
if ~exist(output_dir, 'dir')
    mkdir(output_dir);
end

% Process each sample
num_samples = size(pred_data.all_out, 1);
for sample_idx = 1:num_samples
    fprintf('Processing sample %d/%d...\n', sample_idx, num_samples);
    
    % Convert to vertex level
    vertex_values = zeros(size(cortex_data.pos, 1), 1);
    for v = 1:length(rm_data.region_mapping)
        r = rm_data.region_mapping(v);
        if r > 0
            vertex_values(v) = pred_data.all_out(sample_idx, r);
        end
    end
    
    % Visualize
    figure('Visible', 'off');  % Don't display
    visualize_result(cortex_data.pos, cortex_data.tri, vertex_values', ...
        'FaceAlpha', 0.8, 'thre', 0.1, 'view', [-86, 17]);
    title(sprintf('Sample %d', sample_idx));
    
    % Save
    saveas(gcf, sprintf('%s/sample_%03d.png', output_dir, sample_idx));
    close(gcf);
end

fprintf('Done! Saved %d images to %s\n', num_samples, output_dir);
```

## Troubleshooting

### Problem: "Cannot find file"

**Solution:**
```matlab
% Check where you are
pwd

% Should be in misc_scripts
cd D:\fyp\EEG_Inverse_Problem_with_Transformer_Model\misc_scripts

% Or add to path
addpath('D:\fyp\EEG_Inverse_Problem_with_Transformer_Model\misc_scripts')
```

### Problem: "Undefined function 'visualize_result'"

**Solution:**
Make sure you're in the `misc_scripts` directory or add it to your MATLAB path.

### Problem: No prediction files found

**Solution:**
Run `eval_real.py` first to generate predictions:

```bash
python eval_real.py --checkpoint checkpoints/best_model.pt
```

### Problem: Predictions look strange

**Diagnosis:**
```matlab
% Check prediction statistics
pred_data = load('../source/VEP/transformer_predictions_best_model.mat');
fprintf('Min: %.6f\n', min(pred_data.all_out(:)));
fprintf('Max: %.6f\n', max(pred_data.all_out(:)));
fprintf('Mean: %.6f\n', mean(pred_data.all_out(:)));
fprintf('Std: %.6f\n', std(pred_data.all_out(:)));
```

**Solutions:**
- Try `threshold = 0` to see all values
- Adjust normalization: `'normalize', 0` or `'normalize', 1`
- Check if model predictions are reasonable

### Problem: Want to see negative values

**Solution:**
```matlab
visualize_result(pos, tri, values, ...
    'neg', 1, ...      % Enable bipolar colormap
    'normalize', 0);   % Don't normalize
```

## Files Reference

### Scripts You Can Run

| Script | Purpose | Usage |
|--------|---------|-------|
| `test_visualization.m` | Test setup | `test_visualization` |
| `inspect_anatomy_data.m` | Explore data | `inspect_anatomy_data` |
| `visualize_transformer_predictions.m` | Main visualization | `visualize_transformer_predictions` |
| `visualize_single_prediction.m` | Single sample | `visualize_single_prediction(1)` |
| `compare_predictions.m` | Compare models | `compare_predictions` |

### Documentation Files

| File | Content |
|------|---------|
| `VISUALIZATION_GUIDE.md` | Comprehensive guide with examples |
| `README_VISUALIZATION.md` | Script documentation and API reference |
| `VISUALIZATION_QUICKSTART.txt` | Quick reference card |
| `HOW_TO_VISUALIZE.md` | This file - step-by-step tutorial |

### Required Data Files

| File | Location | Description |
|------|----------|-------------|
| `fs_cortex_20k.mat` | `anatomy/` | Cortex geometry (pos, tri) |
| `fs_cortex_20k_region_mapping.mat` | `anatomy/` | Vertex to region mapping |
| `transformer_predictions_*.mat` | `source/VEP/` | Your model predictions |

## Tips for Best Results

1. **Start Simple**: Use `visualize_single_prediction(1)` first to see one sample
2. **Check Data**: Run `inspect_anatomy_data` to understand the structure
3. **Adjust Threshold**: Start with `threshold = 0`, then increase to focus on strong activations
4. **Try Different Views**: Rotate interactively or set different `view_angle` values
5. **Compare Models**: Use `compare_predictions.m` to evaluate different checkpoints
6. **Save Figures**: Save both `.png` (for papers) and `.fig` (for later editing)
7. **Batch Process**: Use the batch export script to save all samples at once

## Next Steps

After visualization:

1. **Analyze Results**: Look for patterns in brain activity
2. **Compare with Ground Truth**: If available, overlay ground truth sources
3. **Model Evaluation**: Compare predictions from different epochs/models
4. **Publication**: Export high-resolution figures for papers
5. **Presentation**: Create animations or multiple views for presentations

## Getting Help

If you need more help:

1. Check `VISUALIZATION_GUIDE.md` for detailed examples
2. Check `README_VISUALIZATION.md` for API documentation
3. Run `test_visualization.m` to diagnose issues
4. Check MATLAB console for error messages
5. Verify file paths and data formats

## Summary

```matlab
% Complete workflow in 3 lines:
cd misc_scripts
test_visualization           % Verify setup
visualize_transformer_predictions  % Visualize!
```

That's it! You should now see your transformer predictions visualized on a 3D brain surface.

For more advanced usage, explore the other documentation files and scripts in the `misc_scripts/` folder.

